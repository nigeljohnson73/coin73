<?php
include_once (__DIR__ . "/../functions.php");
global $api_host;
ob_start ();

$cfiles = array ();
$ncfiles = array ();

function compressFile($fn, $elh = false) {
	global $cfiles, $ncfiles;
	if ($elh) {
		if (strtolower ( @ $_SERVER ['SERVER_NAME'] ) == "localhost") {
			$ncfiles [] = $fn;
		} else {
			$cfiles [] = $fn;
		}
	} else {
		$cfiles [] = $fn;
	}
}

$inc = array ();
$inc = array_merge ( $inc, includeDirectory ( __DIR__, "js" ) );
$inc = array_merge ( $inc, includeDirectory ( __DIR__ . "/_controllers", "js" ) );
$inc = array_merge ( $inc, includeDirectory ( __DIR__ . "/_directives", "js" ) );
$inc = array_merge ( $inc, includeDirectory ( __DIR__ . "/_services", "js" ) );
foreach ( $inc as $file ) {
	if (file_exists ( $file ) && ! is_dir ( $file ) && (basename ( $file ) != basename ( __FILE__ ))) {
		// echo "// adding $file\n";
		compressFile ( $file, true );
	} else {
		// echo "// skipping $file\n";
	}
}

global $cfiles, $ncfiles; // WHY!!!!

$str = "";
if ($cfiles && count ( $cfiles )) {
	foreach ( $cfiles as $file ) {
		$str .= file_get_contents ( $file ) . "\n";
	}
}
$str = str_replace("{{API_HOST}}", $api_host, $str);

$ncstr = "";
if ($ncfiles && count ( $ncfiles )) {
	foreach ( $ncfiles as $file ) {
		$ncstr .= file_get_contents ( $file ) . "\n";
	}
}
$ncstr = str_replace("{{API_HOST}}", $api_host, $ncstr);

/**
 * **************************************************************************
 */

$preload = ob_get_contents ();
ob_end_clean ();

$debug = true;
header ( "Content-type: text/javscript" );
echo "/* COIN73 - (c) 2020 - " . date ( 'Y' ) . " Nigel Johnson, all rights reserved */\n";
if ($debug)
	echo '/* uncompressed: ' . number_format ( strlen ( $ncstr ), 0 ) . ' bytes, ';
$packer = new JavaScriptPacker ( $str );
$str = $packer->pack ();
if ($debug)
	echo 'compressed: ' . number_format ( strlen ( $str . $ncstr ), 0 ) . ' bytes */';
if (strlen ( $preload ))
	echo "\n/*\n" . trim ( $preload ) . "\n*/\n";
echo ("\n" . $str);
echo ("\n" . $ncstr);
?>